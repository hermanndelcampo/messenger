<!DOCTYPE html>

<html>
  <head>
    <title>JSVersion</title>
    <meta charset="UTF-8">
    
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    
    <script>
    
    var pc1, pc2, sendChannel, receiveChannel, pcConstraint, dataConstraint;

    function createConnection() {
      
      //setup peer
      var servers = null;
      pcConstraint = null;
      dataConstraint = null;
      
      //setup
      pc1 = new webkitRTCPeerConnection(servers, pcConstraint);
      
      pc1.onicecandidate = iceCallback1; 
      
      //same.. setup
      pc2 = new webkitRTCPeerConnection(servers, pcConstraint);
      
      pc2.onicecandidate = iceCallback2;
      pc2.ondatachannel = receiveChannelCallback;
      
      
      function iceCallback1(event) { 
        console.log('local ice callback');
        
        if (event.candidate) {
          pc2.addIceCandidate(event.candidate);
          
          console.log('Local ICE candidate: \n' + event.candidate.candidate);
        }
      }
      
      function iceCallback2(event) {
        console.log('remote ice callback');
        
        if (event.candidate) {
          pc1.addIceCandidate(event.candidate);
          
          console.log('Remote ICE candidate: \n ' + event.candidate.candidate);
        }
      }
      
      
      
      
      //connect p1 -> p2
      
      try {
        sendChannel = pc1.createDataChannel("sendDataChannel", dataConstraint);
        console.log('Created send data channel');
      } catch (e) {
        console.log("error datachannel"); 
      }
      
      
      sendChannel.onopen = onSendChannelStateChange;
      sendChannel.onclose = onSendChannelStateChange;
      
      pc1.createOffer(function (desc) {
        pc1.setLocalDescription(desc);
        
        console.log('Offer from pc1 \n' + desc.sdp);
        pc2.setRemoteDescription(desc);
        pc2.createAnswer(gotDescription2);
      });
      
    }
    
    function sendData() {
      var data = dataChannelSend.value;
      sendChannel.send(data);
      console.log('Sent Data: ' + data);
    }
    
    function closeDataChannels() {
      console.log('Closing data Channels');
      sendChannel.close();
      console.log('Closed data channel with label: ' + sendChannel.label);
      receiveChannel.close();
      console.log('Closed data channel with label: ' + receiveChannel.label);
      pc1.close(); 
      pc2.close();
      pc1 = null;
      pc2 = null;
      console.log('Closed peer connections');
    }
    
    
    
    function gotDescription2(desc) {
      pc2.setLocalDescription(desc);
      console.log('Answer from pc2 \n' + desc.sdp);
      pc1.setRemoteDescription(desc);
    }
    
    
    
    function receiveChannelCallback(event) {
      console.log('Receive Channel Callback');
      
      receiveChannel = event.channel;
      receiveChannel.onmessage = onReceiveMessageCallback;
      receiveChannel.onopen = onReceiveChannelStateChange;
      receiveChannel.onclose = onReceiveChannelStateChange;  
    }
    
    function onReceiveMessageCallback(event) {
      console.log('Received Message: ' + event.data);
    }
    
    function onSendChannelStateChange() {
      var readyState = sendChannel.readyState;
      console.log('Send channel state is: ' + readyState);
      
      if (readyState == "open") {
        console.log("datachannel open");
        sendChannel.send("test");
      } else {
        console.log("dc not open");
      }
    }
    
    function onReceiveChannelStateChange() {
      var readyState = receiveChannel.readyState;
      console.log('Receive channel state is: ' + readyState);
    }
    
    
    $( document ).ready(function() {
      
      createConnection();
    });
    
    </script>
  </head>
 
  <body>   
    <p id="text"></p>
    
    <!-- for this next line to work, your pubspec.yaml file must have a dependency on 'browser' -->
    <script src="packages/browser/dart.js"></script>
  </body>
</html>
